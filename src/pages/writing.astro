---
import type { CollectionEntry } from "astro:content";
import PostLayout from "../layouts/Post.astro";
import BackButton from "@/components/BackButton.astro";
import { formatDate } from "@/utils/date.ts";
import { getAllPosts } from "../utils/post";

const allPosts: CollectionEntry<"post">[] = await getAllPosts();

const postByYear: Record<number, CollectionEntry<"post">[]> = allPosts.reduce(
    (acc, post) => {
        const year = post.data.publishDate.getFullYear();
        if (!acc[year]) {
            acc[year] = [];
        }
        acc[year].push(post);
        return acc;
    },
    {} as Record<number, CollectionEntry<"post">[]>,
);

const postByYearArray = Object.entries(postByYear)
    .map(([year, posts]) => ({
        year: parseInt(year, 10),
        posts,
    }))
    .sort((a, b) => b.year - a.year);
---

<PostLayout title="Ce que je sais">
    <BackButton href="/" />

    <section class="archive">
        {
            postByYearArray.map(({ year, posts }) => (
                <div class="archive__year-block">
                    <h2 class="archive__year" aria-label={`AnnÃ©e ${year}`}>
                        {year}
                    </h2>

                    <ul class="archive__list" role="list">
                        {posts.map((post) => (
                            <li class="archive__item">
                                <a
                                    href={`/fr/post${post.slug.replace("fr/writing", "")}`}
                                    class="archive__link"
                                >
                                    <span class="archive__title">
                                        {post.data.title}
                                    </span>
                                    <time
                                        class="archive__date"
                                        dateTime={post.data.publishDate}
                                    >
                                        {formatDate(
                                            post.data.publishDate,
                                            "dd.MM",
                                        )}
                                    </time>
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            ))
        }
    </section>
</PostLayout>
